Running NSLPK
=============

This folder contains the following files:
* **nslpk.cafe**, which contains the specification of the NSLPK protocol.
* **all_proofs.cafe**, which contains the proof score for verifying the NSLPK protocol. They can be introduced into the system and used to infer a CiMPA proof by using CiMPG.
* **nslpk-proof-generate_inv1.cafe**, which contains the CiMPA script automatically generated for the first invariant (nonce secrecy). The proof assumes the second and the third properties have been proved beforehand and can be used.
* **nslpk-proof-generate_inv2.cafe**, which contains the CiMPA script automatically generated for the second invariant. Note that this invariant is independent from the rest of the proof.
* **nslpk-proof-generate_inv3.cafe**, which contains the CiMPA script automatically generated for the third invariant. Note that this invariant is independent from the rest of the proof.
* **commands_generate_with_proven.cafe**, which contains the CiMPG+F commands for generating **nslpk-proof-generate_inv1.cafe**, **nslpk-proof-generate_inv2.cafe**, and **nslpk-proof-generate_inv3.cafe**.
* **nslpk-proof-generate.cafe**, which contains the CiMPA script automatically generated for the three invariants.
* **commands_generate.cafe**, which contains the CiMPG+F commands for generating **nslpk-proof-generate.cafe**.
* **nslpk-proof.cafe**, which contains the CiMPA script generated for the three invariants by using the proof score in **all_proofs.cafe**.
* **commands_cimpg.cafe**, which contains the CiMPG+F commands for generating **nslpk-proof.cafe**.

Starting the tool and loading NSLPK
-----------------------------------

As explained in the main page, the tool is started by typing:

```
    $ maude -allow-files src/cafeInMaude.maude
```

Once the tool is started, we can introduce modules and try to verify proofs. All proofs in the next subsections will require to load the specification, which is done by typing:

```
    $ CafeInMaude> load ../examples/CCiMPG/NSLPK/nslpk.cafe .
```

Generating a proof script using proof scores
--------------------------------------------

As indicated above, the commands for generating the proof script in this case are available in **commands_cimpg.cafe**. Although it would be enough to load this file (the load required to load it is included at the end of the file), we describe the commands that have been used.

We first need to load the proof score by using the **load** command. Note that the open-close environments in this file are labeled by using **nslpk**:

```
load ../examples/CCiMPG/NSLPK/all_proofs.cafe .
```

In our case we set the number of cores to 4:

```
set-cores 4 .
```

We also set the path of the file that will be used to save the generated proof:

```
set-output ../examples/CCiMPG/NSLPK/nslpk-proof.cafe .
```

The following command is used to ask CiMPG+F to infer the proof. In this case, because the whole proof is coded into the proof score, the proof script will be completely generated by CiMPG. In any case, the command in both cases is the same:

```
:infer-proof nslpk .
```

Once the proof is finished, we can save it by using:

```
:save-proof .
```

This proof would be loaded into CiMPA as follows:

```
load ../examples/CCiMPG/NSLPK/nslpk-proof.cafe .
```

Inferring a proof script assuming invariants are mutually dependent
-------------------------------------------------------------------

The commands for generating theis proof are available in **commands_generate.cafe**, so it can be directly loaded (note that commands after eof will not be executed, so the proof will finish once the script has been generated). We will describe here the commands in the file that are different from the ones above.

In this case we define an open-close environment containing the tree invariants we want to prove. These invariants will have a variable in the term where induction takes place and fresh constants in the rest of terms. We must label the environment so we can refer to it later. In this case we have used the label **proofNSLPK**. Note that this variable is completely independent from the label in the proof score (**all_proofs.cafe**):

```
open NSLPK .
  :id(proofNSLPK)

  ops n1 n2 : -> Nonce .
  op  q : -> Prin .

  red inv1(S:Sys, n1) .
  red inv2(S:Sys, n1, q) .
  red inv3(S:Sys, n1, n2, q) .
close
```

Now, it is enough to ask CiMPG+F to generate the proof for these properties:

```
:infer-proof proofNSLPK .
```

Inferring a proof script
------------------------

The proof of this protocol is simple enough to be generated independently of the relations between the properties. However, more complex protocols may require a careful analysis of the relations between properties, so the state space does not grow to big. In our case, the first invariant (the nonce secrecy) is the property we want to prove, while the second and the third properties are auxiliary. Hence, the first invariant relies on the auxiliary ones, but these auxiliary properties can be analyzed separately. We describe how to prove the invariants using these ideas. The file **commands_generate_with_proven.cafe** contains the commands for this proof, that vary depending on the goal to be analyzed. The first property requires the user to assert that the second and the third invariant can be used. Then, we introduce the nonce secrecy property in an open-close environment:

```
:proven(inv2(S:Sys, N1:Nonce, Q:Prin))
:proven(inv3(S:Sys, N1:Nonce, N2:Nonce, Q:Prin))

open NSLPK .
  :id(proofNSLPK)

  ops n1 n2 : -> Nonce .
  op  q : -> Prin .

  red inv1(S:Sys, n1) .
close
```

The second and the third invariant are very similar and just require the property to be defined in an open-close environment. The second property is defined as:

```
open NSLPK .
  :id(proofNSLPK)

  ops n1 n2 : -> Nonce .
  op  q : -> Prin .

  red inv2(S:Sys, n1, q) .
close
```

While the third one is defined as:

```
open NSLPK .
  :id(proofNSLPK)

  ops n1 n2 : -> Nonce .
  op  q : -> Prin .

  red inv3(S:Sys, n1, n2, q) .
close
```

In all cases, once the open-close environment has been loaded we need to generate the proof by typing:

```
:infer-proof proofNSLPK .
```














